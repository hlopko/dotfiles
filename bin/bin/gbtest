#!/bin/bash
#
# From Destroy All Software screencast #10, at:
# http://destroyallsoftware.com/screencasts/catalog/fast-tests-with-and-without-rails
#
# Released under the MIT license: http://opensource.org/licenses/MIT
#
# tweaked with love by mh

function debug {
  # echo $1
  echo ""
}

set -e
need_rails=1
if [ $# -gt 0 ]; then # we have args
  filename=$1
  # Remove trailing line numbers from filename, e.g. spec/my_spec.rb:33
  grep_filename=`echo $1 | sed 's/:.*$//g'`
  # when called on tested class, find spec
	set +e; echo "$grep_filename" | grep '^app' > /dev/null
	if [ $? -eq 0 ]; then # no match? we have a stand-alone spec or class in lib
		grep_filename=`echo "$grep_filename" | sed 's/^app/spec/' | sed 's/.rb$/_spec.rb/'`
		filename="$grep_filename`echo "$filename" | sed 's/[^:]*//'`"
	fi
	set +e; echo "$grep_filename" | grep '^lib' > /dev/null
	if [ $? -eq 0 ]; then # no match? we really have a stand-alone spec
		grep_filename=`echo "$grep_filename" | sed 's/^lib/spec\/lib/' | sed 's/.rb$/_spec.rb/'`
		filename="$grep_filename`echo "$filename" | sed 's/[^:]*//'`"
	fi
    set +e; grep -r '\bspec_helper\b' $grep_filename > /dev/null
    if [ $? -eq 1 ]; then # no match; we have a stand-alone spec
		debug "X"
		need_rails=0
    fi
	set -e
else # we have no args
	#we dont want rails
	need_rails=0
  filename="--profile 5 `find spec -name '*spec.rb' | xargs grep -iL 'spec_helper' | xargs grep -iL '^# slow spec$' | xargs`"
fi

command='rspec'
if [ -e '.bundle/binstubs/rspec' -a $need_rails -ne 1 ]; then
  debug "B"
  command='.bundle/binstubs/rspec'
fi

if [ $need_rails -eq 1 ]; then
  debug "R"
	if [ -e bin/spring ]; then
    debug "Spring"
    command="bin/spring $command"
	else
    command="bundle exec $command"
	fi
fi
debug "Calling nice -n 19 $command $filename"
RAILS_ENV=test time --quiet -f"\n\nDuration %e\n\n" nice -n 19 $command $filename
