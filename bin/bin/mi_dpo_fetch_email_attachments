#!/usr/bin/env ruby

require 'gmail'
require 'fileutils'
CHECK_SINCE = Date.parse("2013-11-22")

login = `~/.offlineimap.py`.strip
password =  `~/.offlineimap.py password`.strip
Gmail.new(login, password) do |gmail|
  puts 'Logged in!'
  count = gmail.mailbox('cvut').count(after: CHECK_SINCE)
  counter = 0
  puts "Going to check #{count} emails"
  gmail.mailbox('cvut').emails(after: CHECK_SINCE).select do |mail|
    counter += 1
    if mail.subject && mail.subject.include?("[MI-DPO][2013]")
      mail.attachments.each do |attachment|
        puts "Processing email #{mail.subject}, status #{counter}/#{count}"
        if attachment.content_type.include?("zip")
          from = mail.from[0].gsub(/@.*/, "")
          FileUtils.mkdir_p("/home/m/Projects/teaching/dpo/2014/submissions/#{from}")
          fname = "/home/m/Projects/teaching/dpo/2014/submissions/#{from}/#{attachment.filename}"
          File.open(fname, "w+b", 0644) { |f| f.write attachment.body.decoded }
        end
      end
    end
  end
end
