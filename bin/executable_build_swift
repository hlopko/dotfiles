#!/bin/bash

set -euo pipefail

cd ~/projects/swift/swift

mkdir -p ../build

flag="_"
if [[ "$#" > 0 ]]; then
flag="${1}"
shift
fi

if [[ "${flag}" == "-d" ]]; then
  echo "[BUILD-SWIFT]: Debug build"
  ln -nfs Ninja-RelWithDebInfoAssert+swift-DebugAssert ../build/current

  CC=$HOME/chromium-clang/bin/clang CXX=$HOME/chromium-clang/bin/clang++ ./utils/build-script \
    --release-debuginfo \
    --host_cc=$HOME/chromium-clang/bin/clang \
    --host_cxx=$HOME/chromium-clang/bin/clang++ \
    --force-optimized-typechecker \
    --extra-cmake-options="-DCMAKE_C_COMPILER=$HOME/chromium-clang/bin/clang,-DCMAKE_CXX_COMPILER=$HOME/chromium-clang/bin/clang++,-DSWIFT_APPEND_VC_REV=Off,-DLLVM_APPEND_VC_REV=Off,-DLLVM_USE_LINKER=lld,-DCMAKE_CXX_FLAGS='-fno-limit-debug-info -fstandalone-debug -glldb -Wno-error=elaborated-enum-base',-DCMAKE_C_FLAGS='-fno-limit-debug-info -fstandalone-debug -glldb',-DCMAKE_BUILD_TYPE=Debug,-DLLVM_USE_SPLIT_DWARF:BOOL=true,-DLLVM_OPTIMIZED_TABLEGEN=ON" \
    --cmake-c-launcher $(which gomacc) \
    --cmake-cxx-launcher $(which gomacc) \
    --jobs=200 \
    $@
else
  echo "[BUILD-SWIFT]: Release build"
  ln -nfs Ninja-ReleaseAssert ../build/current

  CC=$HOME/chromium-clang/bin/clang CXX=$HOME/chromium-clang/bin/clang++ ./utils/build-script \
    --release \
    --extra-cmake-options="-DCMAKE_C_COMPILER=$HOME/chromium-clang/bin/clang,-DCMAKE_CXX_COMPILER=$HOME/chromium-clang/bin/clang++,-DSWIFT_APPEND_VC_REV=Off,-DLLVM_APPEND_VC_REV=Off,-DLLVM_USE_LINKER=lld,-DCMAKE_CXX_FLAGS='-Wno-error=elaborated-enum-base'" \
    --host_cc=$HOME/chromium-clang/bin/clang \
    --host_cxx=$HOME/chromium-clang/bin/clang++ \
    --cmake-c-launcher $(which gomacc) \
    --cmake-cxx-launcher $(which gomacc) \
    --jobs=200 \
    $@
fi
